<!DOCTYPE html>
<html>
  <head>
  <script>
  
  const selected = []
  
  function drawForm(data, formId, prefix) {
  
    if (!data) return
    
    var output = ''
    
    for (var i = 0; i < data.length; i++) {
    
        if (data[i] == '') continue;
          
        var item = data[i].split(',')
        var key = item[0]
        var value = item[1]
          
        output += '<span name=\''+value+'\'>'
          output += '<input type=\'checkbox\' name=\''+ prefix + key+'\' value=\'' + prefix + key + '\' onchange="handleChange(this);">'
          output += value
          output += '<br>'
        output += '</span>'
    }
    
    document.getElementById(formId).innerHTML = output
  }
  
  function handleChange(c) {
  
    if (c.checked)
      selected.push(c.value)
    else {
      var indexOf = selected.indexOf(c.value)
      
      if (indexOf > -1)
        selected.splice(indexOf, 1)
     }
  }
  
  var onData = function(result) {
    drawForm(result['customer'], 'form', 'USER_INTEREST:')
    drawForm(result['custom'], 'formCustom', 'CUSTOM_AFFINITY:')
  }
  
  google.script.run.withSuccessHandler(onData).getValidationData();
  
  function set() {
    google.script.run.withSuccessHandler(x=>{}).setValues(selected)
  }
  
  function reset() {
    
    var elements = document.getElementById('form').getElementsByTagName('input')
    for (var i = 0; i < elements.length; i++) {
      elements[i].checked = false
    }
   
    var elements = document.getElementById('formCustom').getElementsByTagName('input')
    for (var i = 0; i < elements.length; i++) {
      elements[i].checked = false
    }
    
    var filter = document.getElementById('filter')
    filter.value = ''
    filter_targets(filter)
    
    selected.length = 0
  }
  
  function custom(e) {
    
    const show = e.value
    const hide = show === 'Custom' ? 'Customer' : 'Custom'
    
    e.value = hide
    document.getElementById(hide).style.display = "none"
    document.getElementById(show).style.display = ""
  }
  
  function filter_targets(field) {
  
    var filter = field.value.toUpperCase()
    var elements = document.getElementById('form').getElementsByTagName("span")
  
    for (i = 0; i < elements.length; i++) {
    
      var span = elements[i]
      var txtValue = span.getAttribute('name')
      
      if (txtValue.toUpperCase().indexOf(filter) > -1)
        span.style.display = "";
      else
        span.style.display = "none";
    }
  }
  
  </script>
  </head>
  <body>
    <div style='position:fixed; padding-top: 10px; background-color: white; height: 30px; width: 100%; top: 0;'>
      <input type="button" value="Set to cell" onclick="set()" />
      <input type="button" value="Clear selected" onclick="reset()" />
      <input type="button" value="Custom" onclick="custom(this)" />
    </div>
    
    <div id ="Customer" style="font-family: sans-serif; padding-top: 30px; font-size: 12px;">
    
      <input style="position: fixed;" type="text" id="filter" onkeyup="filter_targets(this)" placeholder="Filter targets...">
    
      <form id="form" name="form" style="padding-top: 30px;">
        <h4 style="text-align:center; font-size: 16px;">Loading targets...</h4>
      </form>
    </div>
    
    <div id ="Custom" style="font-family: sans-serif; padding-top: 30px; font-size: 12px; display: none;">
    
      <form id="formCustom" name="formCustom" style="padding-top: 10px;">
      </form>
    </div>
  </body>
<html>
